<script src="https://connect.soundcloud.com/sdk/sdk-3.0.0.js"></script>

<script>

var source, analyser, context, dataArray, bufferLength, fft;

function setup(){

  context = new webkitAudioContext(),
  audio = new Audio(), source, url = 'http://api.soundcloud.com/tracks/234292033/stream' + '?client_id=e6cec03e9db1f86a994857320fa6b7e3';
  audio.crossOrigin = "anonymous";
  audio.src = url;
  source = context.createMediaElementSource(audio);
  analyser = context.createAnalyser();
  source.connect(analyser);
  analyser.connect(context.destination);
  source.mediaElement.play();

  analyser.fftSize = 4096;
  bufferLength = analyser.frequencyBinCount;
  console.log(bufferLength);
  dataArray = new Uint8Array(bufferLength);

  botPeak = 0;
  botHighPeak = 0;
  midPeak = 0;
  midHighPeak = 0;
  highPeak = 0;
}

var myVar = setInterval(myAjax, 5000);
var myTime = setInterval(myTimer, 20);
var array = []
var payloadArray = []

var timer = 0

function myTimer(){
  payloadArray.push(array)
  botPeak = 0;
  botHighPeak = 0;
  midPeak = 0;
  midHighPeak = 0;
  highPeak = 0;
}

function myAjax() {
  console.log(payloadArray)
  $.ajax({
          type: 'POST',
          url: '/songs',
          data: { frequencies: payloadArray }
      });

  payloadArray = []
}

function draw(){
  drawVisual = requestAnimationFrame(draw);
  analyser.getByteFrequencyData(dataArray);

  var botFreq = dataArray[6];
  var botHighFreq = dataArray[12];
  var midFreq = dataArray[50];
  var midHighFreq = dataArray[300];
  var highFreq = dataArray[500];

  if ((botPeak < botFreq) && (botFreq != null)){
      botPeak = botFreq;

      array = [botPeak, botHighPeak, midPeak, midHighPeak, highPeak]
      // console.log(array);

  }

  if ((botHighPeak < botHighFreq) && (botHighFreq != null)){
      botHighPeak = botHighFreq;

      array = [botPeak, botHighPeak, midPeak, midHighPeak, highPeak]
      // console.log(array);
  }

  if ((midPeak < midFreq) && (midFreq != null)){
      midPeak = midFreq;

      array = [botPeak, botHighPeak, midPeak, midHighPeak, highPeak]
      // console.log(array);
  }

  if ((midHighPeak < midHighFreq)  && (midHighFreq != null)){
      midHighPeak = midHighFreq;

      array = [botPeak, botHighPeak, midPeak, midHighPeak, highPeak]
      // console.log(array);
  }

  if ((highPeak < highFreq) && (highFreq != null)){
      highPeak = highFreq;

      array = [botPeak, botHighPeak, midPeak, midHighPeak, highPeak]
      // console.log(array);
  }

  endShape();
}

</script>
